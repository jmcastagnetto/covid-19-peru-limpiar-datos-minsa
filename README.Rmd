---
output: md_document
---

```{r include=FALSE, echo=FALSE}
library(tidyverse)
load("datos/datos_abiertos_minsa_covid-19_peru.Rdata")
```

[![DOI](https://zenodo.org/badge/266025854.svg)](https://zenodo.org/badge/latestdoi/266025854)


**Última actualización**: `r lubridate::now(tzone = "UTC")` UTC

## Notas 

**2020-05-22**

- La limpieza de datos no está completa aún, hay fechas de tomas de prueba que parecen ser incorrectas, y que al convertir dan fechas inconsistentes con el primer caso reportado (2020-03-06). 
- En al menos un caso, la fecha de toma de pruebas es copia de la fecha de nacimiento. 
- He agregado una columna `fecha_prueba_antes_primer_caso` para marcar esos registros. Son 126 registros que tienen este problema.

**2020-05-23**

- Los datos han cambiado de formato, ya no incluyen la fecha de nacimiento, sino la edad en años.
- El campo de fecha que se tiene ahora ya no es `FECHA_PRUEBA` sino `FECHA_RESULTADO`
- El campo de tipo de prueba (antes `TIPO_PRUEBA`) se llama ahora `METODODX`
- Hay 4,543 registros sin fecha de resultado conocida
- Ya no hay incosistencias en los formatos de fecha, todos los registros con valores son de la forma "DD/MM/YYYY"
- Tampoco hay errores como fechas anteriores al primer caso reportado oficialmente.
- Usando edad, departamento, provincia y distrito se han podidor reconstruir unos 2,933 registros de casos con fallecimientos

**2020-05-28**

- Hay nuevos datasets de positivos y fallecimientos, ahora ambos en formato CSV, pero no en UTF-8:
  - ["Casos positivos por COVID-19 - [Ministerio de Salud - MINSA]"](https://www.datosabiertos.gob.pe/dataset/casos-positivos-por-covid-19-ministerio-de-salud-minsa)
  - ["Fallecidos por COVID-19 - [Ministerio de Salud - MINSA]"](https://www.datosabiertos.gob.pe/dataset/fallecidos-por-covid-19-ministerio-de-salud-minsa)

**2020-05-31**

- Nuevo cambio de formato en los datos de fallecimientos: en 749 de registros no se consigna la fecha de nacimiento, pero se ha agregado una columna `EDAD_DECLARADA`. 
- He modificado el código para compensar por estos cambios.
- También, **todos los 141 fallecimientos asignados al 2020-05-29 están designados como de sexo `INDETERMINADO`**.

**2020-06-12**

- Al menos a partir de ayer, ya aparecen nuevamente los valores definidos para el sexo en los datos.

## Información relevante

Fuentes de datos:

- https://www.datosabiertos.gob.pe/dataset/casos-positivos-por-covid-19-ministerio-de-salud-minsa
- https://www.datosabiertos.gob.pe/dataset/fallecidos-por-covid-19-ministerio-de-salud-minsa

Luego del primer paso de limpieza de datos:

```{r comment=""}
summary(casos)
```

```{r comment=""}
summary(fallecimientos)
```

```{r comment=""}
summary(reconstruido)
```

Hay coincidencias entre casos y fallecimientos, usando edad, sexo y lugar en `r nrow(filter(reconstruido, coincidencias == 1))` casos reconstruídos.

```{r echo=FALSE}
plot_df <- casos %>% 
  mutate(
    sexo = str_replace_na(sexo, "No registrado")
  ) %>% 
  group_by(fecha_resultado, sexo) %>% 
  tally() %>% 
  filter(!is.na(fecha_resultado)) %>% 
  arrange(fecha_resultado)

Sys.setlocale("LC_TIME", "es_PE.utf8")
plot_casos <- ggplot(
  plot_df,
  aes(x = fecha_resultado, y = n, group = sexo, fill = sexo)
) +
  geom_col() +
  labs(
    fill = "Sexo",
    x = "Fecha de resultado",
    y = "",
    title = "Positivos COVID-19 por día, de \"positivos_covid.csv\" del MINSA",
    subtitle = paste0(
      "Del ", min(plot_df$fecha_resultado), " al ",
      max(plot_df$fecha_resultado),
      ". Actualizado el: ",
                      lubridate::now(tzone = "UTC"), " UTC"),
    caption = "Código: https://github.com/jmcastagnetto/covid-19-peru-limpiar-datos-minsa // @jmcastagnetto, Jesus M. Castagnetto"
  ) +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    legend.position = c(.2, .8),
    axis.title.x.bottom = element_text(hjust = 1)
  )

ggsave(
  plot = plot_casos,
  filename = "positivos-por-dia-minsa.png",
  width = 6.5,
  height = 4
)

plot_acum_df <- casos %>% 
  group_by(fecha_resultado) %>% 
  tally() %>% 
  filter(!is.na(fecha_resultado)) %>% 
  arrange(fecha_resultado) %>% 
  mutate(
    n_acum = cumsum(n)
  )

plot_casos_acum <- ggplot(
  plot_acum_df,
  aes(x = fecha_resultado, y = n_acum)
) +
  geom_point(size = .5) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Fecha de resultado",
    y = "",
    title = "Positivos COVID-19 acumulados, de \"positivos_covid.csv\" del MINSA",
    subtitle = paste0(
      "Del ", min(plot_df$fecha_resultado), " al ",
      max(plot_df$fecha_resultado),
      ". Actualizado el: ",
                      lubridate::now(tzone = "UTC"), " UTC"),
    caption = "Código: https://github.com/jmcastagnetto/covid-19-peru-limpiar-datos-minsa // @jmcastagnetto, Jesus M. Castagnetto"
  ) +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    axis.title.x.bottom = element_text(hjust = 1)
  )

ggsave(
  plot = plot_casos_acum,
  filename = "positivos-acumulados-minsa.png",
  width = 6.5,
  height = 4
)

```

!["Positivos por día. MINSA"](positivos-por-dia-minsa.png)

!["Positivos acumulados. MINSA"](positivos-acumulados-minsa.png)

```{r echo=FALSE}
plot_fall_df <- fallecimientos %>% 
  group_by(fecha_fallecimiento, sexo) %>% 
  tally() %>% 
  arrange(fecha_fallecimiento)

plot_fallecimientos <- ggplot(
  plot_fall_df,
  aes(x = fecha_fallecimiento, y = n, 
      group = sexo, fill = sexo)
) +
  geom_col() +
  labs(
    fill = "Sexo",
    x = "Fecha de fallecimiento",
    y = "",
    title = "Fallecimientos COVID-19 por día, de \"fallecidos_covid.csv\" del MINSA",
    subtitle = paste0(
      "Del ", min(plot_fall_df$fecha_fallecimiento), " al ",
      max(plot_fall_df$fecha_fallecimiento),
      ". Actualizado el: ",
                      lubridate::now(tzone = "UTC"), " UTC"),
    caption = "Código: https://github.com/jmcastagnetto/covid-19-peru-limpiar-datos-minsa // @jmcastagnetto, Jesus M. Castagnetto"
  ) +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    legend.position = c(.2, .8),
    axis.title.x.bottom = element_text(hjust = 1)
  )

ggsave(
  plot = plot_fallecimientos,
  filename = "fallecimientos-por-dia-minsa.png",
  width = 6.5,
  height = 4
)

plot_fall_acum_df <- fallecimientos %>% 
  group_by(fecha_fallecimiento) %>% 
  tally() %>% 
  filter(!is.na(fecha_fallecimiento)) %>% 
  arrange(fecha_fallecimiento) %>% 
  mutate(
    n_acum = cumsum(n)
  )

plot_fallecimientos_acum <- ggplot(
  plot_fall_acum_df,
  aes(x = fecha_fallecimiento, y = n_acum)
) +
  geom_point(size = .5) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Fecha de fallecimiento",
    y = "",
    title = "Fallecimientos COVID-19 acumulados, de \"fallecidos_covid.csv\" del MINSA",
    subtitle = paste0(
      "Del ", min(plot_df$fecha_resultado), " al ",
      max(plot_df$fecha_resultado),
      ". Actualizado el: ",
                      lubridate::now(tzone = "UTC"), " UTC"),
    caption = "Código: https://github.com/jmcastagnetto/covid-19-peru-limpiar-datos-minsa // @jmcastagnetto, Jesus M. Castagnetto"
  ) +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    axis.title.x.bottom = element_text(hjust = 1)
  )

ggsave(
  plot = plot_fallecimientos_acum,
  filename = "fallecimientos-acumulados-minsa.png",
  width = 6.5,
  height = 4
)

```


!["Fallecimientos por día. MINSA"](fallecimientos-por-dia-minsa.png)

!["Fallecimientos acumulados. MINSA"](fallecimientos-acumulados-minsa.png)

```{r echo=FALSE}
plot_reconstruido_df <- reconstruido %>% 
  mutate(
    dias_caso_fall = lubridate::interval(
      fecha_resultado,
      fecha_fallecimiento
    ) %/% lubridate::days()
  )

plot_reconstruido_dist <- ggplot(
  plot_reconstruido_df,
  aes(x = dias_caso_fall, y = sexo)
) +
  geom_violin(aes(fill = sexo), 
              draw_quantiles = c(.25, .5, .75),
              show.legend = FALSE) +
  facet_wrap(~coincidencias) +
  labs(
    x = "Días entre prueba positiva y fallecimiento",
    y = "",
    title = "Distribución de detección a fallecimiento por número de registros coincidentes",
    subtitle = paste0(
      "Coincidencias estimadas usando sexo, edad y lugar. Actualizado el: ",
      lubridate::now(tzone = "UTC"), " UTC"),
    caption = "Código: https://github.com/jmcastagnetto/covid-19-peru-limpiar-datos-minsa // @jmcastagnetto, Jesus M. Castagnetto"
  ) +
  theme_linedraw() +
  theme(
    plot.title.position = "plot",
    axis.title.x.bottom = element_text(hjust = 1)
  )

ggsave(
  plot = plot_reconstruido_dist,
  filename = "deteccion-fallecimiento-por-coincidentes.png",
  width = 6.5,
  height = 4
)


```

!["Distribución de tiempos desde detección a fallecimiento, por número de registros coincidentes"](deteccion-fallecimiento-por-coincidentes.png)


Los archivos "limpios" son:

- datos/DATOSABIERTOS_SISCOVID-utf8-limpio.csv.gz
- datos/FALLECIDOS_CDC-utf8-limpio.csv.gz

Y algunos reconstruidos con los anteriores:

- datos/casos_fallecimientos_reconstruccion_posible.csv.gz
- datos/timeseries-casos.csv.gz
- datos/timeseries-casos-lugares.csv.gz
- datos/timeseries-fallecimientos.csv.gz
- datos/timeseries-fallecimientos-lugares.csv.gz
